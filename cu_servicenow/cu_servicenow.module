<?php

/**
 * @file
 * This module sets up a boolean value for webforms to integrate with ServiceNow.
 */

/**
 * Implements hook_form_form_id_alter().
 *
 * Move the SN checkbox to the publishing tab.
 */
function cu_servicenow_form_webform_node_form_alter(&$form, &$form_state) {
  $form['options']['field_cu_servicenow'] = $form['field_cu_servicenow'];
  unset($form['field_cu_servicenow']);
}

/**
 * Implements hook_form_alter().
 *
 * Add custom submit handler to send info to ServiceNow.
 */
function cu_servicenow_form_alter(&$form, &$form_state) {
  if (isset($form['#node']->webform) && $form['#node']->field_cu_servicenow['und'][0]['value']) {
    $form['#submit'][] = 'servicenow_submit';
  }
}

/**
 * Custom submit handler for forms with SN integaration enabled.
 */
function servicenow_submit(&$form, &$form_state) {
  // If the current node has SN enabled, do code, else move on.
  watchdog('cu_servicenow', 'ServiceNow custom submit handler was hit.');
  $form_values = $form_state['input']['submitted'];
  $file_location = $form_state['complete form']['submitted']['attachment']['#file']->uri;
  _servicenow_curl_request($form_values, $file_location);
  dpm($file_location);
  dpm($form_state);
}

function _snow_url() {
  $snow_url = variable_get('servicenow_environment', 'https://dev21034.service-now.com/api/now/table/incident');

  return $snow_url;
}

function _get_headers_from_curl_response($response) {
  $headers = array();

  $header_text = substr($response, 0, strpos($response, "\r\n\r\n"));

  foreach (explode("\r\n", $header_text) as $i => $line)
    if ($i === 0)
      $headers['http_code'] = $line;
    else
    {
      list ($key, $value) = explode(': ', $line);

      $headers[$key] = $value;
    }

  return $headers;
}

/**
 * ServiceNow API call via cURL.
 *
 * Send in form_values from the custom submit handler.
 * The values must match available fields in ServiceNow.
 */
function _servicenow_curl_request($form_values, $file_location) {
  $request = "https://dev21034.service-now.com/api/now/table/incident";
  $content_encode = json_encode($form_values);
  $ch = curl_init(); // initialize curl handle
  curl_setopt($ch, CURLOPT_HTTPHEADER, Array("Accept:application/json","Content-Type:application/json"));
  curl_setopt($ch, CURLOPT_USERPWD, "admin:oJjqG7UMe7rV");
  curl_setopt($ch, CURLOPT_URL, $request);
  curl_setopt($ch, CURLOPT_POSTFIELDS, $content_encode);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
  curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 10);
  curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
  $result = curl_exec($ch); // run the whole process
  curl_setopt($ch, CURLOPT_HEADER, 1);
  curl_setopt($ch, CURLOPT_VERBOSE, 1);
  //$header = curl_exec($ch); // run the whole process
  curl_close($ch); // close cURL handler

  //$headers = _get_headers_from_curl_response($header);
  $result = json_decode($result);
  _servicenow_curl_request_file_upload($result->result->sys_id, $file_location);
  //$result->headers = $headers;
  if ( (!isset($result->status)) && (!empty($result)) ) {
    $result->status = 'success';
  } else {
    $result->status = 'failure';
  }
  if ( ($result->status == 'failure') || (empty($result)) ) {
    watchdog('cu_servicenow', 'servicenow api not communicating correctly \_(ツ)_/¯ api call: ' . $request);
    //return NULL;
    dpm('no worked');
    //return $header;
  } else {
    dpm($result);
    return $result;
  }
}

/**
 * ServiceNow API call via cURL.
 *
 * Send in form_values from the custom submit handler.
 * The values must match available fields in ServiceNow.
 */
function _servicenow_curl_request_file_upload($sys_id, $file_location) {
  /*
  curl "https://instance.service-now.com/api/now/attachment/upload" \
  --request POST \
  --header "Accept:application/json"
  --user 'admin':'admin'"\
  --header "Content-Type:multipart/form-data"
   -F 'table_name=incident' -F 'table_sys_id=d71f7935c0a8016700802b64c67c11c6' -F 'encryption_context=undefined'-F 'uploadFile=@ location of the file on file system'
   */

  $request = "https://dev21034.service-now.com/api/now/attachment/upload";
  $ch = curl_init(); // initialize curl handle
  curl_setopt($ch, CURLOPT_HTTPHEADER, Array("Accept:application/json", "Content-Type:multipart/form-data"));
  curl_setopt($ch, CURLOPT_USERPWD, "admin:oJjqG7UMe7rV");
  curl_setopt($ch, CURLOPT_URL, $request);
  curl_setopt($ch, CURLOPT_POSTFIELDS, 'table_name=incident');
  curl_setopt($ch, CURLOPT_POSTFIELDS, 'table_sys_id=' . $sys_id);
  curl_setopt($ch, CURLOPT_POSTFIELDS, 'uploadFile=@' . $file_location);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
  curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 10);
  curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
  $result = curl_exec($ch); // run the whole process
  curl_exec($ch);
  watchdog('cu_servicenow', 'ServiceNow attempted attachment upload ' . $request);
  curl_close($ch); // close cURL handler
}